{% extends 'todo/base.html' %}

{% block title %}Todo List{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Todo List</h1>
    <div class="d-flex gap-2">
        <a href="{% url 'task_report' %}" class="btn btn-info">View Task Report</a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
            Create Task
        </button>
    </div>
</div>

<!-- Create Task Modal -->
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createTaskModalLabel">Create New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_title_modal" class="form-label">Title</label>
                        <input type="text" name="title" class="form-control" id="id_title_modal" required>
                        <div class="invalid-feedback" id="error_title_modal"></div>
                    </div>
                    <div class="mb-3">
                        <label for="id_description_modal" class="form-label">Description</label>
                        <textarea name="description" class="form-control" id="id_description_modal" rows="3"></textarea>
                        <div class="invalid-feedback" id="error_description_modal"></div>
                    </div>
                    <div class="mb-3">
                        <label for="id_time_spent_hours_modal" class="form-label">Time Spent (hours)</label>
                        <input type="number" step="0.1" name="time_spent_hours" class="form-control" id="id_time_spent_hours_modal" placeholder="e.g., 1.5">
                        <div class="invalid-feedback" id="error_time_spent_hours_modal"></div>
                    </div>
                    <div class="mb-3">
                        <label for="id_estimation_time_hours_modal" class="form-label">Estimation Time (hours)</label>
                        <input type="number" step="0.1" name="estimation_time_hours" class="form-control" id="id_estimation_time_hours_modal" placeholder="e.g., 2.0">
                        <div class="invalid-feedback" id="error_estimation_time_hours_modal"></div>
                    </div>
                    <div class="mb-3">
                        <label for="id_status_modal" class="form-label">Status</label>
                        <select name="status" class="form-select" id="id_status_modal">
                            <option value="todo">To Do</option>
                            <option value="inprogress">In Progress</option>
                            <option value="blocker">Blocker</option>
                            <option value="done">Done</option>
                        </select>
                        <div class="invalid-feedback" id="error_status_modal"></div>
                    </div>
                    <div class="mb-3">
                        <label for="id_project_modal" class="form-label">Project</label>
                        <select name="project" class="form-select" id="id_project_modal">
                            <option value="">---------</option>
                            {# Assuming 'all_projects' is passed in context from the view #}
                            {% for project in all_projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback" id="error_project_modal"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Form -->
<form id="todoSearchForm" method="get" action="{% url 'todo_list' %}" class="mb-3">
    <div class="row g-2 align-items-end mb-3">
        <div class="col-lg-3 col-md-12">
            <label for="q_search_todo" class="form-label mb-1">Search Tasks</label>
            <div class="input-group input-group-sm">
                <input type="text" id="q_search_todo" name="q" class="form-control form-control-sm" placeholder="Min 3 chars..." value="{{ query | default:'' }}">
                <!-- Search button is hidden by #todoSearchForm button[type="submit"] -->
            </div>
        </div>
        <div class="col-lg-2 col-md-6 col-sm-12">
            <label for="startDate" class="form-label mb-1">Start Date</label>
            <input type="date" class="form-control form-control-sm" id="startDate" name="start_date" value="{{ selected_start_date | default:'' }}">
        </div>
        <div class="col-lg-2 col-md-6 col-sm-12">
            <label for="endDate" class="form-label mb-1">End Date</label>
            <input type="date" class="form-control form-control-sm" id="endDate" name="end_date" value="{{ selected_end_date | default:'' }}">
        </div>
        <div class="col-lg-2 col-md-6 col-sm-12">
            <label for="statusFilter" class="form-label mb-1">Status</label>
            <select class="form-select form-select-sm" id="statusFilter" name="status">
                {% for status_opt in status_options %}
                    <option value="{{ status_opt.value }}" {% if selected_status == status_opt.value %}selected{% endif %}>{{ status_opt.display }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-lg-2 col-md-6 col-sm-12">
            <label for="projectFilter" class="form-label mb-1">Project</label>
            <select class="form-select form-select-sm" id="projectFilter" name="project">
                <option value="">All Projects</option>
                {% for project_opt in all_projects %} {# Assuming all_projects is a list of dicts with id and name #}
                    <option value="{{ project_opt.id }}" {% if selected_project_id == project_opt.id %}selected{% endif %}>{{ project_opt.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-lg-1 col-md-12">
            <a href="{% url 'todo_list' %}" class="btn btn-secondary btn-sm w-100 mt-md-0 mt-2">Reset Filters</a>
        </div>
    </div>
</form>

<table class="table table-striped table-hover align-middle">
    <thead>
        <tr>
            <th>
                <a href="?order_by={% if request.GET.order_by == 'title' %}-title{% else %}title{% endif %}&q={{ query | default:'' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">
                    Title {% if request.GET.order_by == 'title' %}▲{% elif request.GET.order_by == '-title' %}▼{% endif %}
                </a>
            </th>
            <th>Description</th> {# Assuming description is not a primary sort field #}
            <th>Time Spent (hours)</th>
            <th>Estimation Time (hours)</th>
            <th>
                <a href="?order_by={% if request.GET.order_by == 'status' %}-status{% else %}status{% endif %}&q={{ query | default:'' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">
                    Status {% if request.GET.order_by == 'status' %}▲{% elif request.GET.order_by == '-status' %}▼{% endif %}
                </a>
            </th>
            <th>
                <a href="?order_by={% if request.GET.order_by == 'project__name' %}-project__name{% else %}project__name{% endif %}&q={{ query | default:'' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">
                    Project {% if request.GET.order_by == 'project__name' %}▲{% elif request.GET.order_by == '-project__name' %}▼{% endif %}
                </a>
            </th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for todo in page_obj %}  {# Use page_obj here #}
        <tr data-id="{{ todo.id }}">
            <td data-field="title"><b><a href="{% url 'todo_detail' todo.id %}">{{ todo.title }}</a></b></td>
            <td data-field="description" title="{{ todo.description }}">{{ todo.description }}</td>
            <td data-field="time_spent">{{ todo.time_spent_hours|floatformat:2 }}h</td>
            <td data-field="estimation_time">{{ todo.estimation_time_hours|floatformat:2 }}h</td>
            <td data-field="status" data-value="{{ todo.status }}">
                {% if todo.status == 'done' %}
                    <span class="badge bg-success">{{ todo.get_status_display }}</span>
                {% elif todo.status == 'inprogress' %}
                    <span class="badge bg-primary">{{ todo.get_status_display }}</span>
                {% elif todo.status == 'blocker' %}
                    <span class="badge bg-danger">{{ todo.get_status_display }}</span>
                {% else %} {# Default to 'todo' or any other status #}
                    <span class="badge bg-warning text-dark">{{ todo.get_status_display }}</span>
                {% endif %}
            </td>
            <td data-field="project" data-project-id="{{ todo.project.id | default:'' }}">{{ todo.project.name | default:"N/A" }}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-primary me-1 inline-edit-btn" title="Inline Edit"><i class="fas fa-pencil-alt"></i></button>
                <a href="{% url 'edit_todo' todo.id %}" class="btn btn-sm btn-outline-secondary me-1" title="Edit Page"><i class="fas fa-edit"></i></a>
                <button class="btn btn-sm btn-danger delete-todo-btn" data-todo-id="{{ todo.id }}" data-delete-url="{% url 'delete_todo' todo.id %}" title="Delete"><i class="fas fa-trash-alt"></i></button>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted">
                You have no tasks yet. <a href="{% url 'add_todo' %}">Add one!</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1&q={{ query | default:'' }}&order_by={{ current_order_by | default:'-created_at' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">&laquo; First</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query | default:'' }}&order_by={{ current_order_by | default:'-created_at' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">Previous</a></li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
            <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

        {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query | default:'' }}&order_by={{ current_order_by | default:'-created_at' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">Next</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ query | default:'' }}&order_by={{ current_order_by | default:'-created_at' }}&start_date={{ selected_start_date|default:'' }}&end_date={{ selected_end_date|default:'' }}&status={{ selected_status|default:'' }}&project={{ selected_project_id|default:'' }}">Last &raquo;</a></li>
        {% else %}
            <li class="page-item disabled"><span class="page-link">Next</span></li>
            <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
        {% endif %}
    </ul>
</nav>

{% csrf_token %} {# For AJAX POST requests #}

{{ all_projects|json_script:"all-projects-data" }}

<style>
    /* Hide the original inline edit button */
    .inline-edit-btn {
        display: none !important;
    }

    /* Hide the search button in the todo list search form */
    #todoSearchForm button[type="submit"] {
        display: none;
    }
</style>

<script>
    // Make all_projects available to JavaScript if passed in context
    var all_projects = []; // Default to empty array
    try {
        const allProjectsDataElement = document.getElementById('all-projects-data');
        if (allProjectsDataElement) {
            all_projects = JSON.parse(allProjectsDataElement.textContent);
        }
    } catch (e) {
        console.error("Could not parse all_projects data:", e);
    }

document.addEventListener('DOMContentLoaded', function () {
    const tableBody = document.querySelector('.table tbody');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value; // General CSRF for inline edit

    // --- Create Task Modal Logic ---
    const createTaskModal = new bootstrap.Modal(document.getElementById('createTaskModal'));
    const createTaskForm = document.getElementById('createTaskForm');
    const createCsrfToken = createTaskForm.querySelector('[name=csrfmiddlewaretoken]').value; // CSRF for create form

    createTaskForm.addEventListener('submit', function(event) {
        event.preventDefault();
        clearCreateFormErrors();

        const formData = new FormData(createTaskForm);
        // The 'completed' field is being phased out in favor of 'status'.
        // If your backend still uses 'completed', you might need to derive it from 'status'.
        // For now, we'll assume 'status' is the primary field.
        // formData.set('completed', formData.get('status') === 'done' ? 'true' : 'false');


        // Convert FormData to a plain object for JSON stringification
        const data = {};
        formData.forEach((value, key) => {
            if (key === 'csrfmiddlewaretoken') return;

            // Example: Deriving 'completed' if necessary for backend compatibility
            // if (key === 'status' && value === 'done') {
            //    data['completed'] = true;
            // } else if (key === 'status' && value !== 'done') {
            //    data['completed'] = false;
            // }

            if (key === 'time_spent_hours') {
                data[key] = value ? parseFloat(value) : null;
            } else if (key === 'project') {
                // Ensure project ID is sent, or null if not selected
                data[key] = value ? parseInt(value) : null;
            }
            // Ensure 'completed' is explicitly set based on 'status' if it's still used by the backend logic for creation.
            // Otherwise, if 'completed' is fully removed from the model or handled by 'status' on save, this is not needed.
            else {
                data[key] = value;
            }
        });
        // Ensure 'completed' is derived from status if it's still part of the form submission expected by the view for 'add_todo'
        // This depends on how the 'add_todo' view and 'TodoForm' handle the 'completed' field.
        // If TodoForm still has 'completed', it might be auto-set by status, or it needs to be sent.
            // For the purpose of this update, we assume 'status' is the source of truth.


        fetch("{% url 'add_todo' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': createCsrfToken, // Use the token from the create form
                'X-Requested-With': 'XMLHttpRequest' // To help Django identify AJAX
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errData => {
                    throw { status: response.status, data: errData };
                });
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                addTodoToTable(result.todo);
                createTaskModal.hide();
                createTaskForm.reset();
                // Optionally, show a success message (e.g., using a toast)
            } else if (result.errors) {
                // This case should be caught by the !response.ok check if status is 400
                displayCreateFormErrors(result.errors);
            }
        })
        .catch(errorInfo => {
            console.error('Error creating task:', errorInfo);
            if (errorInfo.status === 400 && errorInfo.data && errorInfo.data.errors) {
                const errors = JSON.parse(errorInfo.data.errors); // errors are JSON string
                displayCreateFormErrors(errors);
            } else if (errorInfo.data && errorInfo.data.error) {
                 // Generic error from server not related to form fields
                alert('Error: ' + errorInfo.data.error);
            }
            else {
                alert('An unexpected error occurred while creating the task. Please try again.');
            }
        });
    });

    function clearCreateFormErrors() {
        createTaskForm.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        createTaskForm.querySelectorAll('.form-control, .form-check-input').forEach(el => el.classList.remove('is-invalid'));
    }

    function displayCreateFormErrors(errors) {
        for (const fieldName in errors) {
            const errorMessages = errors[fieldName].map(e => e.message).join(', ');
            const field = createTaskForm.querySelector(`[name="${fieldName}"]`);
            const errorDiv = createTaskForm.querySelector(`#error_${fieldName}_modal`); // e.g. #error_title_modal

            if (field) {
                field.classList.add('is-invalid');
            }
            if (errorDiv) {
                errorDiv.textContent = errorMessages;
            } else {
                // Fallback if a specific error div isn't found for a field (e.g. non_field_errors)
                // Or display a general error message at the top of the modal
                const generalErrorDiv = createTaskForm.querySelector('#general_create_errors_modal'); // You'd need to add this div to the modal
                if (generalErrorDiv) generalErrorDiv.textContent += `${fieldName}: ${errorMessages}\n`;
                else alert(`Error for ${fieldName}: ${errorMessages}`); // Fallback
            }
        }
    }

    function addTodoToTable(todo) {
        const newRow = tableBody.insertRow(0); // Insert at the top or use appendRow for bottom
        newRow.dataset.id = todo.id;

        const titleHtml = `<b><a href="/todo_detail/${todo.id}/">${todo.title}</a></b>`;
        let statusHtml;
        let statusValue = todo.status || 'todo'; // Default to 'todo' if undefined
        let statusText = todo.get_status_display || 'To Do'; // Default text

        // Assuming todo.status gives 'todo', 'inprogress', 'done'
        // and todo.get_status_display gives the human-readable form.
        // If result.todo from AJAX is raw, we need to map it:
        const statusDisplayMap = {
            'todo': 'To Do',
            'inprogress': 'In Progress',
            'blocker': 'Blocker',
            'done': 'Done'
        };
        statusText = statusDisplayMap[statusValue] || 'To Do';


        if (statusValue === 'done') {
            statusHtml = `<span class="badge bg-success">${statusText}</span>`;
        } else if (statusValue === 'inprogress') {
            statusHtml = `<span class="badge bg-primary">${statusText}</span>`;
        } else if (statusValue === 'blocker') {
            statusHtml = `<span class="badge bg-danger">${statusText}</span>`;
        } else { // todo
            statusHtml = `<span class="badge bg-warning text-dark">${statusText}</span>`;
        }
        newRow.setAttribute('data-value', statusValue); // Set data-value on the <tr> or status <td> for consistency

        const timeSpentDisplay = todo.time_spent_hours != null ? `${parseFloat(todo.time_spent_hours).toFixed(2)}h` : "0.00h";
        const estimationTimeDisplay = todo.estimation_time_hours != null ? `${parseFloat(todo.estimation_time_hours).toFixed(2)}h` : "0.00h";
        const projectNameDisplay = todo.project_name || "N/A";
        const projectIdAttribute = todo.project_id || "";

        newRow.innerHTML = `
            <td data-field="title">${titleHtml}</td>
            <td data-field="description" title="${todo.description || ''}">${todo.description || ''}</td>
            <td data-field="time_spent">${timeSpentDisplay}</td>
            <td data-field="estimation_time">${estimationTimeDisplay}</td>
            <td data-field="status">${statusHtml}</td>
            <td data-field="project" data-project-id="${projectIdAttribute}">${projectNameDisplay}</td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-primary me-1 inline-edit-btn">Inline Edit</button>
                <a href="/todo/${todo.id}/edit/" class="btn btn-sm btn-outline-secondary">Edit Page</a>
                <a href="/delete_todo/${todo.id}/" class="btn btn-sm btn-danger">Delete</a>
            </td>
        `;
        // If there's an "empty" message row, remove it
        const emptyRow = tableBody.querySelector('tr td[colspan="6"]');
        if (emptyRow) {
            emptyRow.parentElement.remove();
        }
    }

    // --- End Create Task Modal Logic ---

    // Combined event listener for table body
    tableBody.addEventListener('click', function (event) {
        const target = event.target;
        const row = target.closest('tr');

        if (!row || !row.dataset.id) { // Check if click is on a valid row
             // Handle delete button click specifically, as it might be the only button on the row
            if (target.classList.contains('delete-todo-btn')) {
                event.preventDefault();
                const todoId = target.dataset.todoId;
                const deleteUrl = target.dataset.deleteUrl;
                const specificRowToRemove = target.closest('tr'); // a more specific row for removal

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken, // Defined above
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw err; });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                if (specificRowToRemove) specificRowToRemove.remove();
                                Swal.fire('Deleted!','Your task has been deleted.','success');
                                if (tableBody.querySelectorAll('tr').length === 0) {
                                    const emptyMessageHtml = `
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                You have no tasks yet. <a href="{% url 'add_todo' %}">Add one!</a>
                                            </td>
                                        </tr>`;
                                    tableBody.innerHTML = emptyMessageHtml;
                                }
                            } else {
                                Swal.fire('Failed!', data.error || 'Could not delete the task.', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting task:', error);
                            Swal.fire('Error!', error.error || 'An unexpected error occurred.', 'error');
                        });
                    }
                });
            } // End of delete button logic
            return; // If not on a valid row and not delete button, do nothing
        }


        // If we are on a valid row (row && row.dataset.id is true)
        const todoId = row.dataset.id;

        // Handle "Inline Edit" button click
        // if (target.classList.contains('inline-edit-btn')) { // Original logic for button
        //     if (row.classList.contains('editing')) return;
        //     enterEditMode(row, target); // target here was the edit button
        // }
        // Handle "Save" button click
        if (target.classList.contains('save-btn')) {
            saveChanges(row, todoId);
        }
        // Handle "Cancel" button click
        else if (target.classList.contains('cancel-btn')) {
            cancelEditMode(row);
        }
        // Handle "Delete" button click (already handled above, this is a fallback)
        else if (target.classList.contains('delete-todo-btn')) {
            // This logic is mostly covered by the initial check, but keeping it as a safeguard
            event.preventDefault();
            const deleteUrl = target.dataset.deleteUrl;
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(deleteUrl, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (row) row.remove(); // Use current row
                            Swal.fire('Deleted!','Your task has been deleted.','success');
                             if (tableBody.querySelectorAll('tr').length === 0) {
                                const emptyMessageHtml = `
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            You have no tasks yet. <a href="{% url 'add_todo' %}">Add one!</a>
                                        </td>
                                    </tr>`;
                                tableBody.innerHTML = emptyMessageHtml;
                            }
                        } else {
                            Swal.fire('Failed!', data.error || 'Could not delete the task.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error!', 'An unexpected error occurred.', 'error');
                    });
                }
            });
        }
        // New: Handle click on TD for inline editing
        else if (target.tagName === 'TD' && !row.classList.contains('editing')) {
            // Avoid triggering edit mode if clicking on a link, button, or any form element within the TD
            const isInteractiveElement = target.querySelector('a, button, input, select, textarea') ||
                                         event.target.closest('a, button, input, select, textarea');
            if (isInteractiveElement && isInteractiveElement !== target) { // Click was on child interactive element
                 // console.log('Clicked on interactive child, not entering edit mode.');
                return;
            }
            if (target.closest('.actions-cell')) { // Assuming actions cell has a class or check last child
                 // console.log('Clicked on actions cell, not entering edit mode.');
                return;
            }

            // Find the original edit button to pass to enterEditMode, or null if not needed
            // For now, enterEditMode is adapted to not strictly need it if it's hidden.
            // const originalEditButton = row.querySelector('.inline-edit-btn'); // May be hidden
            enterEditMode(row);
        }
    });

    function enterEditMode(row) {
        row.classList.add('editing');
        // row.dataset.originalHtml = {}; // This was not used, using specific data attributes instead

        // Title
        const titleCell = row.querySelector('td[data-field="title"]');
        const titleLink = titleCell.querySelector('a');
        const currentTitle = titleLink ? titleLink.textContent : titleCell.textContent.trim();
        row.dataset.originalHtmlTitle = titleCell.innerHTML;
        const titleInput = document.createElement('input');
        titleInput.type = 'text';
        titleInput.className = 'form-control form-control-sm';
        titleInput.value = currentTitle;
        titleInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges(row, row.dataset.id);
            }
        });
        titleCell.innerHTML = '';
        titleCell.appendChild(titleInput);
        titleInput.focus();

        // Description
        const descriptionCell = row.querySelector('td[data-field="description"]');
        const currentDescription = descriptionCell.textContent.trim();
        row.dataset.originalHtmlDescription = descriptionCell.innerHTML;
        descriptionCell.innerHTML = `<textarea class="form-control form-control-sm">${currentDescription}</textarea>`;

        // Time Spent (hours)
        const timeCell = row.querySelector('td[data-field="time_spent"]');
        const currentTimeText = timeCell.textContent.trim().replace('h', '');
        const currentTime = parseFloat(currentTimeText) || 0;
        row.dataset.originalHtmlTime = timeCell.innerHTML;
        const timeInput = document.createElement('input');
        timeInput.type = 'number';
        timeInput.step = '0.1';
        timeInput.className = 'form-control form-control-sm';
        timeInput.value = currentTime;
        timeInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges(row, row.dataset.id);
            }
        });
        timeCell.innerHTML = '';
        timeCell.appendChild(timeInput);

        // Estimation Time (hours)
        const estimationTimeCell = row.querySelector('td[data-field="estimation_time"]');
        const currentEstimationTimeText = estimationTimeCell.textContent.trim().replace('h', '');
        const currentEstimationTime = parseFloat(currentEstimationTimeText) || 0;
        row.dataset.originalHtmlEstimationTime = estimationTimeCell.innerHTML;
        const estimationTimeInput = document.createElement('input');
        estimationTimeInput.type = 'number';
        estimationTimeInput.step = '0.1';
        estimationTimeInput.className = 'form-control form-control-sm';
        estimationTimeInput.value = currentEstimationTime;
        estimationTimeInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges(row, row.dataset.id);
            }
        });
        estimationTimeCell.innerHTML = '';
        estimationTimeCell.appendChild(estimationTimeInput);

        // Status
        const statusCell = row.querySelector('td[data-field="status"]');
        const currentStatusValue = statusCell.dataset.value; // 'todo', 'inprogress', 'done'
        row.dataset.originalHtmlStatus = statusCell.innerHTML;
        statusCell.innerHTML = `
            <select class="form-select form-select-sm">
                <option value="todo" ${currentStatusValue === 'todo' ? 'selected' : ''}>To Do</option>
                <option value="inprogress" ${currentStatusValue === 'inprogress' ? 'selected' : ''}>In Progress</option>
                <option value="blocker" ${currentStatusValue === 'blocker' ? 'selected' : ''}>Blocker</option>
                <option value="done" ${currentStatusValue === 'done' ? 'selected' : ''}>Done</option>
            </select>
        `;
        const statusSelect = statusCell.querySelector('select');
        statusSelect.addEventListener('keydown', function(e) { // Changed from change to keydown for Enter
            if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges(row, row.dataset.id);
            }
        });
        // Also save on change for select elements, as users might expect that
        statusSelect.addEventListener('change', function(e) {
            saveChanges(row, row.dataset.id);
        });


        // Project
        const projectCell = row.querySelector('td[data-field="project"]');
        const currentProjectId = projectCell.dataset.projectId;
        row.dataset.originalHtmlProject = projectCell.innerHTML;
        let projectOptionsHtml = '<option value="">---------</option>';
        // Assuming 'all_projects' is available globally or fetched dynamically
        // For now, this part will rely on 'all_projects' being in the template's JS scope.
        // A better approach would be an API call if 'all_projects' is large or dynamic.
        if (typeof all_projects !== 'undefined' && Array.isArray(all_projects)) {
            all_projects.forEach(project => {
                projectOptionsHtml += `<option value="${project.id}" ${currentProjectId == project.id ? 'selected' : ''}>${project.name}</option>`;
            });
        } else {
            // Fallback or indicate loading, this needs to be robust
            // If all_projects isn't guaranteed, this select will be empty or show a default.
            // For now, we'll proceed assuming it might be available.
            // If the project currently assigned is not in all_projects, it won't be pre-selected.
            // Consider adding the current project to the options if not in all_projects
            // (e.g. if all_projects is a filtered list the user can assign, but the task has an old/different one)
            const currentProjectName = projectCell.textContent.trim();
            if (currentProjectId && currentProjectName !== "N/A") {
                 // Check if current project is already in the options generated
                if (!projectOptionsHtml.includes(`value="${currentProjectId}"`)) {
                    projectOptionsHtml += `<option value="${currentProjectId}" selected>${currentProjectName} (Current)</option>`;
                }
            }
        }
        projectCell.innerHTML = `<select class="form-select form-select-sm">${projectOptionsHtml}</select>`;
        const projectSelect = projectCell.querySelector('select');
        projectSelect.addEventListener('keydown', function(e) { // Changed from change to keydown for Enter
             if (e.key === 'Enter') {
                e.preventDefault();
                saveChanges(row, row.dataset.id);
            }
        });
        // Also save on change for select elements
        projectSelect.addEventListener('change', function(e) {
            saveChanges(row, row.dataset.id);
        });

        // Change buttons
        const actionsCell = row.querySelector('td:last-child'); // Assume actions cell is always last
        // If editButtonOrNull was passed and is valid, use it to find actionsCell for robustness
        // const actionsCell = editButtonOrNull ? editButtonOrNull.closest('td') : row.querySelector('td:last-child');

        // Store original actions HTML. This needs to be the actual buttons, not the inputs.
        // The original inline-edit-btn is hidden by CSS. We need to reconstruct the original action buttons' HTML.
        // This part might need to be more robust if the original HTML is complex.
        // For now, we'll assume it's the standard set of buttons (edit, delete, etc.)
        // If we are removing the inline-edit-btn permanently, this will be simpler.
        if (!row.dataset.originalHtmlActions) { // Store only if not already stored (e.g. from a previous edit attempt)
            // Let's capture the state of the action buttons as they are *before* we change them to Save/Cancel
            // The inline-edit-btn is hidden, so we want the Edit Page and Delete buttons.
            const editPageBtnHTML = actionsCell.querySelector('a[href*="/edit/"]')?.outerHTML || '';
            const deleteBtnHTML = actionsCell.querySelector('.delete-todo-btn')?.outerHTML || '';
            // The hidden inline-edit-btn is not needed here for restoration if we are moving away from it.
            row.dataset.originalHtmlActions = `${editPageBtnHTML} ${deleteBtnHTML}`.trim();
        }

        actionsCell.innerHTML = `
            <button type="button" class="btn btn-sm btn-success me-1 save-btn">Save</button>
            <button type="button" class="btn btn-sm btn-warning cancel-btn">Cancel</button>
        `;
    }

    function exitEditMode(row, newValues) {
        row.classList.remove('editing');

        // Title
        const titleCell = row.querySelector('td[data-field="title"]');
        // Retain link structure if it was there
        const originalTitleHTML = row.dataset.originalHtmlTitle;
        if (originalTitleHTML && originalTitleHTML.includes('<a href')) {
            const link = document.createElement('a');
            link.href = originalTitleHTML.match(/href="([^"]*)"/)[1]; // Extract href
            link.innerHTML = `<b>${newValues.title}</b>`;
            titleCell.innerHTML = ''; // Clear existing input
            titleCell.appendChild(link);
        } else {
            titleCell.innerHTML = `<b>${newValues.title}</b>`;
        }


        // Description
        const descriptionCell = row.querySelector('td[data-field="description"]');
        descriptionCell.textContent = newValues.description;

        // Time Spent
        const timeCell = row.querySelector('td[data-field="time_spent"]');
        timeCell.textContent = `${parseFloat(newValues.time_spent_hours).toFixed(2)}h`;

        // Estimation Time
        const estimationTimeCell = row.querySelector('td[data-field="estimation_time"]');
        estimationTimeCell.textContent = `${parseFloat(newValues.estimation_time_hours).toFixed(2)}h`;

        // Status
        const statusCell = row.querySelector('td[data-field="status"]');
        const newStatusValue = newValues.status;
        statusCell.dataset.value = newStatusValue; // Update data-value for future edits
        let statusBadgeHtml;
        // Assuming newValues.get_status_display is available or we map it
        const statusDisplayMap = {
            'todo': 'To Do',
            'inprogress': 'In Progress',
            'blocker': 'Blocker',
            'done': 'Done'
        };
        const newStatusDisplay = newValues.get_status_display || statusDisplayMap[newStatusValue];

        if (newStatusValue === 'done') {
            statusBadgeHtml = `<span class="badge bg-success">${newStatusDisplay}</span>`;
        } else if (newStatusValue === 'inprogress') {
            statusBadgeHtml = `<span class="badge bg-primary">${newStatusDisplay}</span>`;
        } else if (newStatusValue === 'blocker') {
            statusBadgeHtml = `<span class="badge bg-danger">${newStatusDisplay}</span>`;
        } else { // todo
            statusBadgeHtml = `<span class="badge bg-warning text-dark">${newStatusDisplay}</span>`;
        }
        statusCell.innerHTML = statusBadgeHtml;

        // Project
        const projectCell = row.querySelector('td[data-field="project"]');
        projectCell.textContent = newValues.project_name || "N/A"; // newValues from result.todo
        projectCell.dataset.projectId = newValues.project_id || "";


        // Restore original action buttons
        const actionsCell = row.querySelector('td:last-child'); // Assuming actions are always last
        actionsCell.innerHTML = row.dataset.originalHtmlActions;

        // Clean up stored original HTML
        delete row.dataset.originalHtmlTitle;
        delete row.dataset.originalHtmlDescription;
        delete row.dataset.originalHtmlTime;
        delete row.dataset.originalHtmlStatus;
        delete row.dataset.originalHtmlProject; // Clean up project
        delete row.dataset.originalHtmlActions;
    }

    function cancelEditMode(row) {
        row.classList.remove('editing');
        // Restore original HTML content for each cell
        row.querySelector('td[data-field="title"]').innerHTML = row.dataset.originalHtmlTitle;
        row.querySelector('td[data-field="description"]').innerHTML = row.dataset.originalHtmlDescription;
        row.querySelector('td[data-field="time_spent"]').innerHTML = row.dataset.originalHtmlTime;
        row.querySelector('td[data-field="estimation_time"]').innerHTML = row.dataset.originalHtmlEstimationTime;
        row.querySelector('td[data-field="status"]').innerHTML = row.dataset.originalHtmlStatus;
        row.querySelector('td[data-field="project"]').innerHTML = row.dataset.originalHtmlProject; // Restore project
        row.querySelector('td:last-child').innerHTML = row.dataset.originalHtmlActions; // Action buttons

        // Clean up stored original HTML
        delete row.dataset.originalHtmlTitle;
        delete row.dataset.originalHtmlDescription;
        delete row.dataset.originalHtmlTime;
        delete row.dataset.originalHtmlStatus;
        delete row.dataset.originalHtmlProject; // Clean up project
        delete row.dataset.originalHtmlActions;

        // Clean up original project HTML if stored separately
        delete row.dataset.originalHtmlProject;
    }

    function saveChanges(row, todoId) {
        const title = row.querySelector('td[data-field="title"] input').value;
        const description = row.querySelector('td[data-field="description"] textarea').value;
        const time_spent_hours = parseFloat(row.querySelector('td[data-field="time_spent"] input').value);
        const estimation_time_hours = parseFloat(row.querySelector('td[data-field="estimation_time"] input').value);
        const status = row.querySelector('td[data-field="status"] select').value;
        const projectSelect = row.querySelector('td[data-field="project"] select');
        const project_id = projectSelect.value ? parseInt(projectSelect.value) : null;


        const data = {
            title: title,
            description: description,
            time_spent_hours: time_spent_hours,
            estimation_time_hours: estimation_time_hours,
            status: status,
            project_id: project_id, // Send project_id
        };
        // If your backend for inline_edit specifically needs 'completed', this is where it would be derived.
        // However, since we are removing 'completed' functionality, this is no longer needed.
        // For consistency with the plan, we assume the backend will handle 'status'.

        fetch(`/todo/inline_edit/${todoId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(data),
        })
        .then(response => {
            if (!response.ok) {
                // Try to get error message from server if JSON, otherwise use status text
                return response.json().then(errData => {
                    throw new Error(errData.error || response.statusText);
                }).catch(() => { // Catch if response.json() fails (not JSON error)
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                });
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // The server should return the processed data, including time_spent_hours
                // and project_name, project_id
                exitEditMode(row, result.todo);
            } else {
                alert('Error saving changes: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to save changes: ' + error.message);
            // Optionally, revert to original values or keep inputs for user to retry
        });
    }
});

    // Automatic search and filter application
    const todoSearchForm = document.getElementById('todoSearchForm');
    const searchInput = document.getElementById('q_search_todo'); // Use new ID
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const statusFilterSelect = document.getElementById('statusFilter');
    const projectFilterSelect = document.getElementById('projectFilter');
    let debounceTimer;

    function triggerTodoFormSubmit() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function () {
            if (todoSearchForm) {
                todoSearchForm.submit();
            }
        }, 500); // 500ms delay
    }

    if (todoSearchForm) {
        if (searchInput) {
            searchInput.addEventListener('input', function () {
                const query = searchInput.value.trim();
                if (query.length === 0 || query.length >= 3) {
                    triggerTodoFormSubmit();
                } else {
                    clearTimeout(debounceTimer); // Prevent submission for <3 chars
                }
            });
        }
        if (startDateInput) {
            startDateInput.addEventListener('change', triggerTodoFormSubmit);
        }
        if (endDateInput) {
            endDateInput.addEventListener('change', triggerTodoFormSubmit);
        }
        if (statusFilterSelect) {
            statusFilterSelect.addEventListener('change', triggerTodoFormSubmit);
        }
        if (projectFilterSelect) {
            projectFilterSelect.addEventListener('change', triggerTodoFormSubmit);
        }
    }
</script>
{% endblock %}